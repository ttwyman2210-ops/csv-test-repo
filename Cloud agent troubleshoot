#!/usr/bin/env python3
import certifi
import requests
import os
from getpass import getpass
import pandas as pd

# --- 1. SSL & CREDENTIALS ---
cert_path = certifi.where()
os.environ["REQUESTS_CA_BUNDLE"] = cert_path
os.environ["SSL_CERT_FILE"] = cert_path

username = input("Enter your Qualys username: ")
password = getpass("Enter your Qualys password: ")

BASE_URL = "https://qualysapi.qg4.apps.qualys.com"
ENDPOINT = "/qps/rest/2.0/search/am/hostasset"
api_endpoint = f"{BASE_URL}{ENDPOINT}"

TAG_NAME = 'Retail Store Prod Deployment 2025'

all_records = []
last_id = 0
has_more = True

print(f"[*] Starting full extraction for tag: {TAG_NAME}...")

# --- 2. PAGINATED FETCH LOOP ---
try:
    while has_more:
        # We ensure last_id is an integer for the XML payload
        search_xml = f"""
        <ServiceRequest>
            <filters>
                <Criteria field="tagName" operator="EQUALS">{TAG_NAME}</Criteria>
                <Criteria field="id" operator="GREATER">{int(last_id)}</Criteria>
            </filters>
            <responseOptions>
                <includeFields>agentInfo.lastCheckedIn,name,address,os,id</includeFields>
            </responseOptions>
        </ServiceRequest>
        """

        response = requests.post(
            api_endpoint,
            auth=(username, password),
            headers={
                "X-Requested-With": "Python",
                "Content-Type": "text/xml",
                "Accept": "application/json"
            },
            data=search_xml,
            timeout=120
        )
        response.raise_for_status()
        data = response.json()

        batch = data.get('ServiceResponse', {}).get('data', [])
        
        if not batch:
            has_more = False
        else:
            all_records.extend(batch)
            
            # --- IMPROVED SAFE ID EXTRACTION ---
            last_item = batch[-1]
            
            # Check multiple possible JSON paths for the asset ID
            # 1. Root level 'id'
            # 2. Inside 'hostAsset' object
            # 3. Inside 'HostAsset' (case-sensitive variant)
            possible_id = (
                last_item.get('id') or 
                last_item.get('hostAsset', {}).get('id') or 
                last_item.get('HostAsset', {}).get('id')
            )

            if possible_id is not None:
                last_id = possible_id
                print(f"[*] Fetched {len(all_records)} assets so far... (Current ID: {last_id})")
            else:
                # If we fail to find the ID, print keys to help debug the JSON structure
                print(f"[!] ID not found in batch. Keys present: {list(last_item.keys())}")
                has_more = False
                break
            
            # If Qualys sends less than 100, we have reached the end of the collection
            if len(batch) < 100:
                has_more = False

    # --- 3. DATA PROCESSING & EXPORT ---
    if all_records:
        df = pd.json_normalize(all_records)
        
        # Standardize the date column for Power BI
        date_col = next((c for c in df.columns if 'lastCheckedIn' in c), None)
        if date_col:
            df['lastCheckedIn_DT'] = pd.to_datetime(df[date_col]).dt.tz_localize(None)
            print(f"[*] Date formatting applied to column: {date_col}")

        output_file = 'qualys_assets_for_pbi.csv'
        df.to_csv(output_file, index=False)
        
        print("-" * 30)
        print(f"[+] TOTAL EXPORTED: {len(df)} assets")
        print(f"[+] File saved to: {os.path.abspath(output_file)}")
        print("-" * 30)
    else:
        print("[!] No assets found for that tag. Please verify the tag name in the Qualys console.")

except requests.exceptions.HTTPError as e:
    print(f"[!] Qualys API Error ({response.status_code}): {response.text}")
except Exception as e:
    print(f"[!] Script Error: {e}")
finally:
    print("[*] Process Complete.")
