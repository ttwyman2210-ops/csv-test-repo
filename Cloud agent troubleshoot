#!/usr/bin/env python3
import certifi
import requests
import os
from getpass import getpass
import pandas as pd
import io

# --- SSL & CREDENTIALS ---
cert_path = certifi.where()
os.environ["REQUESTS_CA_BUNDLE"] = cert_path
os.environ["SSL_CERT_FILE"] = cert_path

username = input("Enter your Qualys username: ")
password = getpass("Enter your Qualys password: ")

BASE_URL = "https://qualysapi.qg4.apps.qualys.com"
ENDPOINT = "/qps/rest/2.0/search/am/hostasset"
api_endpoint = f"{BASE_URL}{ENDPOINT}"

TAG_NAME = 'Retail Store Prod Deployment 2025'
DAYS_SINCE_CHECKIN = 30  

# --- THE "FORCE ALL" XML ---
# We use lastId=0 to signal a start-to-finish fetch
# and limitResultSize=1000 to try and push the buffer.
search_xml = f"""
<ServiceRequest>
    <preferences>
        <limitResultSize>1000</limitResultSize>
    </preferences>
    <filters>
        <Criteria field="tagName" operator="EQUALS">{TAG_NAME}</Criteria>
    </filters>
    <responseOptions>
        <includeFields>agentInfo.lastCheckedIn,name,address,os</includeFields>
    </responseOptions>
</ServiceRequest>
"""

try:
    print(f"[*] Fetching ALL assets for tag: {TAG_NAME}...")
    
    response = requests.post(
        api_endpoint,
        auth=(username, password),
        headers={
            "X-Requested-With": "Python",
            "Content-Type": "text/xml",
            "Accept": "application/json"
        },
        data=search_xml,
        timeout=120
    )
    response.raise_for_status()
    data = response.json()

    if 'ServiceResponse' in data and 'data' in data['ServiceResponse']:
        hosts = data['ServiceResponse']['data']
        df = pd.json_normalize(hosts)
        
        print(f"[*] Success! API returned {len(df)} assets.")

        # --- DYNAMIC DATE FILTER ---
        date_col = next((c for c in df.columns if 'lastCheckedIn' in c), None)
        if date_col:
            df['lastCheckedIn_DT'] = pd.to_datetime(df[date_col]).dt.tz_localize(None)
            cutoff = pd.Timestamp.now() - pd.Timedelta(days=DAYS_SINCE_CHECKIN)
            df_filtered = df[df['lastCheckedIn_DT'] >= cutoff].copy()
            
            df_filtered.to_csv('qualys_assets_for_pbi.csv', index=False)
            print(f"[+] {len(df_filtered)} assets saved to CSV.")
        else:
            df.to_csv('qualys_assets_for_pbi.csv', index=False)
            print("[!] Date field not found; saved all retrieved records instead.")
            
except requests.exceptions.HTTPError as e:
    # This will print the EXACT reason Qualys rejected the request
    print(f"[!] API Error: {response.text}")
except Exception as e:
    print(f"[!] Script Error: {e}")
