#!/usr/bin/env python3
import certifi
import requests
import os
from getpass import getpass
import pandas as pd
import io

# --- 1. SSL CERTIFICATE CONFIGURATION ---
cert_path = certifi.where()
os.environ["REQUESTS_CA_BUNDLE"] = cert_path
os.environ["SSL_CERT_FILE"] = cert_path

print(f"[*] Using certifi bundle at: {cert_path}")

# --- 2. CREDENTIALS ---
username = input("Enter your Qualys username: ")
password = getpass("Enter your Qualys password: ")

# --- 3. API CONFIGURATION ---
BASE_URL = "https://qualysapi.qg4.apps.qualys.com"
ENDPOINT = "/qps/rest/2.0/search/am/hostasset"
api_endpoint = f"{BASE_URL}{ENDPOINT}"

HEADERS = {
    "X-Requested-With": "Python",
    "Content-Type": "text/xml",
    "Accept": "application/json"
}

TAG_NAME = 'Retail Store Prod Deployment 2025'
DAYS_SINCE_CHECKIN = 30  

# --- 4. THE SEARCH CRITERIA (XML) ---
# Added <preferences> to increase the limit from 100 to 1000
search_xml = f"""
<ServiceRequest>
    <preferences>
        <limitResultSize>1000</limitResultSize>
    </preferences>
    <filters>
        <Criteria field="tagName" operator="EQUALS">{TAG_NAME}</Criteria>
    </filters>
    <responseOptions>
        <includeFields>agentInfo.lastCheckedIn,name,address,os,lastVmScanDate</includeFields>
    </responseOptions>
</ServiceRequest>
"""

try:
    print(f"[*] Fetching assets with tag: {TAG_NAME}...")
    print(f"[*] Connecting to: {api_endpoint}")
    
    response = requests.post(
        api_endpoint,
        auth=(username, password),
        headers=HEADERS,
        data=search_xml,
        timeout=60
    )
    response.raise_for_status()

    data = response.json()
    
    if 'ServiceResponse' in data and 'data' in data['ServiceResponse']:
        hosts = data['ServiceResponse']['data']
        df = pd.json_normalize(hosts)

        # --- 5. DYNAMIC COLUMN PICKER ---
        date_col = next((c for c in df.columns if 'lastCheckedIn' in c), None)

        if date_col:
            print(f"[*] Found date field: {date_col}")
            
            # Convert to datetime and remove timezone for filtering
            df['lastCheckedIn_DT'] = pd.to_datetime(df[date_col]).dt.tz_localize(None)
            
            # Calculate the cutoff date
            cutoff_date = pd.Timestamp.now() - pd.Timedelta(days=DAYS_SINCE_CHECKIN)
            
            # Perform the filter
            df_filtered = df[df['lastCheckedIn_DT'] >= cutoff_date].copy()

            # --- 6. SAVE FOR POWER BI ---
            output_file = 'qualys_assets_for_pbi.csv'
            df_filtered.to_csv(output_file, index=False)
            print(f"[+] Success! {len(df_filtered)} assets found and exported to {output_file}.")
        else:
            print("[!] Warning: 'lastCheckedIn' field not found in response.")
            df.to_csv('qualys_assets_raw_debug.csv', index=False)
            print("[*] Saved raw output to 'qualys_assets_raw_debug.csv' for inspection.")
    else:
        print("[!] No data returned. Check if the Tag Name is exactly correct.")

except requests.exceptions.HTTPError as e:
    print(f"[!] API Error ({response.status_code}): {response.text}")
except Exception as e:
    print(f"[!] Script Error: {e}")
