import pandas as pd
import datetime
import os
import io

# 1. Locate the file
file_path = os.path.join(os.path.expanduser("~"), "Downloads", "Qualys_Retail_Assets_2025.csv")

try:
    # 2. Robust Loading
    # on_bad_lines='skip' ignores lines that don't match the column count (like the XML footer)
    # engine='python' is slower but much better at handling the EOF error you saw
    df = pd.read_csv(file_path, on_bad_lines='skip', engine='python')

    # 3. Clean up the data
    # Qualys files often have metadata rows at the top. 
    # We find the real header by looking for 'IP' or 'ID' if the first load is messy
    if 'LAST_ACTIVITY' not in df.columns:
        # Fallback: find the row that contains 'LAST_ACTIVITY' and reload
        with open(file_path, 'r') as f:
            lines = f.readlines()
            for i, line in enumerate(lines):
                if 'LAST_ACTIVITY' in line:
                    df = pd.read_csv(io.StringIO("".join(lines[i:])), on_bad_lines='skip')
                    break

    # 4. Filter for Date Logic
    # Convert 'LAST_ACTIVITY' to datetime (UTC)
    df['LAST_ACTIVITY'] = pd.to_datetime(df['LAST_ACTIVITY'], errors='coerce', utc=True)
    
    # Drop rows where date failed to parse
    df = df.dropna(subset=['LAST_ACTIVITY'])

    # 5. Calculate "Silent" Threshold (24 Hours)
    now = datetime.datetime.now(datetime.timezone.utc)
    threshold_24h = now - datetime.timedelta(hours=24)

    # 6. Flag stale assets
    df['Status'] = df['LAST_ACTIVITY'].apply(lambda x: 'Silent' if x < threshold_24h else 'Active')
    
    # Final cleanup: Power BI likes clean dataframes
    final_output = df[['IP', 'DNS', 'LAST_ACTIVITY', 'Status']].copy()
    
    # Summarize for console triage
    print(f"Successfully processed {len(final_output)} assets.")
    print(final_output['Status'].value_counts())

except Exception as e:
    print(f"Error processing Qualys data: {e}")
