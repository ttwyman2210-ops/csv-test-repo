import pandas as pd
import xml.etree.ElementTree as ET
import datetime
import os

# 1. Locate the XML file
# Even if the file extension is .csv, the content is XML, so we treat it as such
file_path = os.path.join(os.path.expanduser("~"), "Downloads", "Qualys_Retail_Assets_2025.csv")

try:
    # 2. Parse the XML structure
    tree = ET.parse(file_path)
    root = tree.getroot()

    # 3. Extract asset data into a list of dictionaries
    assets = []
    
    # Navigate to the <HOST> tags inside <HOST_LIST>
    # Path: RESPONSE -> HOST_LIST -> HOST
    for host in root.findall(".//HOST"):
        asset_data = {
            "ID": host.findtext("ID"),
            "IP": host.findtext("IP"),
            "DNS": host.findtext("DNS"),
            "OS": host.findtext("OS"),
            "LAST_ACTIVITY": host.findtext("LAST_ACTIVITY"),
            "AGENT_STATUS": host.findtext("AGENT_STATUS")
        }
        assets.append(asset_data)

    # 4. Convert to DataFrame
    df = pd.DataFrame(assets)

    if not df.empty:
        # 5. Date Logic
        # Convert LAST_ACTIVITY to datetime (UTC)
        df['LAST_ACTIVITY'] = pd.to_datetime(df['LAST_ACTIVITY'], errors='coerce', utc=True)
        
        # Define the 24-hour threshold
        now = datetime.datetime.now(datetime.timezone.utc)
        threshold_24h = now - datetime.timedelta(hours=24)

        # 6. Create the 'Status' column for Power BI visuals
        df['Status'] = df['LAST_ACTIVITY'].apply(
            lambda x: 'Silent' if pd.notnull(x) and x < threshold_24h else 'Active'
        )
        
        # Clean up any missing values
        df['DNS'] = df['DNS'].fillna('Unknown')
        
        # Final result table for Power BI
        # df will be available as a table in the Power BI "Fields" pane
        print(f"Successfully parsed {len(df)} assets from XML.")
    else:
        print("No <HOST> records found in the XML file.")

except Exception as e:
    print(f"XML Parsing Error: {e}")
