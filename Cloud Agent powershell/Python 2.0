# --- Setup and Credentials ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$ProgressPreference = 'SilentlyContinue'
$User = Read-Host "Qualys Username"; $Pass = Read-Host "Password" -AsSecureString
$bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($Pass)
$Plain = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
$Creds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${User}:${Plain}"))
[System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)

# --- Configuration ---
$Headers = @{ Authorization = "Basic $Creds"; "X-Requested-With" = "PS"; "Accept" = "text/csv" }
$TagId = "26865192"
$TagName = "Retail Store Prod Deployment 2025"
$Uri = "https://qualysapi.qg4.apps.qualys.com/api/5.0/fo/asset/host/?action=list&use_tags=1&tag_set_by=id&tag_set_include=$TagId&show_tags=1"
$Out = Join-Path ([Environment]::GetFolderPath("Downloads")) "Qualys_Retail_Assets.csv"

Write-Host "`nRequesting data for Tag ID: $TagId ..." -ForegroundColor Cyan

# --- Execution ---
try {
    # 1. Download full dataset to disk
    Invoke-WebRequest -Uri $Uri -Headers $Headers -OutFile $Out -UseBasicParsing -TimeoutSec 60

    if (Test-Path $Out) {
        $raw = Import-Csv $Out
        # 2. Bulletproof filter: search for ID or Name in all common Qualys tag columns
        $data = $raw | Where-Object { 
            $_."Tag IDs" -like "*$TagId*" -or 
            $_.Tag_IDs -like "*$TagId*" -or 
            $_.Tags -like "*$TagName*" 
        }

        $count = ($data | Measure-Object).Count
        if ($count -gt 0) {
            # 3. Clean and save verified assets
            $data | Export-Csv $Out -NoTypeInformation
            Write-Host "Success! Data verified and cleaned." -ForegroundColor Green
            
