# --- Ensure modern TLS ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$ProgressPreference = 'SilentlyContinue'

# --- Prompt for credentials ---
$Username = Read-Host "Enter your Qualys API username"
$SecurePassword = Read-Host "Enter your Qualys API password" -AsSecureString

$bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($SecurePassword)
try {
    $PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
    $pair = "${Username}:${PlainPassword}"
    $encodedCreds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($pair))
} finally {
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)
    $PlainPassword = $null
    $pair = $null
}

$Headers = @{
    Authorization    = "Basic $encodedCreds"
    "X-Requested-With" = "PowerShell"
}

# --- Validation and Asset Counting Logic ---
$TagId = "26865192"
# Endpoint for retrieving tag details
$ValidationUrl = "https://qualysapi.qg4.apps.qualys.com/qps/rest/2.0/get/am/tag/$TagId"
# Endpoint for searching/counting assets by Tag ID
$CountUrl = "https://qualysapi.qg4.apps.qualys.com/qps/rest/2.0/count/am/hostasset"

Write-Host "`nStep 1: Verifying Tag ID ${TagId}..." -ForegroundColor Cyan

try {
    # 1. Verify Tag Existence and Metadata
    $response = Invoke-RestMethod -Uri $ValidationUrl -Headers $Headers -Method Get
    $tagData = $response.ServiceResponse.data.Tag
    
    if ($tagData) {
        Write-Host "SUCCESS: Tag Validated" -ForegroundColor Green
        Write-Host "--------------------------------------------------" -ForegroundColor Gray
        Write-Host "Tag Name:    $($tagData.name)" -ForegroundColor Yellow -Bold
        Write-Host "Created:     $($tagData.created)" -ForegroundColor Gray
        Write-Host "--------------------------------------------------" -ForegroundColor Gray

        # 2. Count Total Assets associated with this Tag ID
        Write-Host "Step 2: Counting assets associated with this tag..." -ForegroundColor Cyan
        
        $countCriteria = @"
        <ServiceRequest>
            <filters>
                <Criteria field="tagName" operator="EQUALS">$($tagData.name)</Criteria>
            </filters>
        </ServiceRequest>
"@
        
        $countResponse = Invoke-RestMethod -Uri $CountUrl -Headers $Headers -Method Post -Body $countCriteria -ContentType "text/xml"
        $assetCount = $countResponse.ServiceResponse.count
        
        if ($null -ne $assetCount) {
            Write-Host "TOTAL ASSETS RETRIEVED: " -NoNewline
            Write-Host "$assetCount" -ForegroundColor Yellow -Bold
            Write-Host "--------------------------------------------------" -ForegroundColor Gray
        } else {
            Write-Warning "Tag found, but asset count could not be retrieved."
        }
    } else {
        Write-Host "ERROR: Tag ID ${TagId} not found." -ForegroundColor Red
    }
} 
catch {
    Write-Host "CRITICAL: API connection failed." -ForegroundColor Red
    if ($_.Exception.Response) {
        $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
        Write-Host "Server Response: $($reader.ReadToEnd())" -ForegroundColor Yellow
    }
}
finally {
    $encodedCreds = $null
    $ProgressPreference = 'Continue'
}
