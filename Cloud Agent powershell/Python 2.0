# --- Setup and Credentials ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$ProgressPreference = 'SilentlyContinue'
$User = Read-Host "Qualys Username"
$Pass = Read-Host "Password" -AsSecureString
$bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($Pass)
$Plain = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
$Creds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("${User}:${Plain}"))
[System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)

# --- Configuration ---
$Headers = @{ Authorization = "Basic $Creds"; "X-Requested-With" = "PS"; "Accept" = "text/csv" }
$TagId = "26865192"
$TagName = "Retail Store Prod Deployment 2025"
$Uri = "https://qualysapi.qg4.apps.qualys.com/api/5.0/fo/asset/host/?action=list&use_tags=1&tag_set_by=id&tag_set_include=$TagId&show_tags=1"
$Out = Join-Path ([Environment]::GetFolderPath("Downloads")) "Qualys_Retail_Assets.csv"

Write-Host "`nRequesting data for Tag ID: $TagId ..." -ForegroundColor Cyan

# --- Execution ---
try {
    # 1. Download full dataset to disk
    Invoke-WebRequest -Uri $Uri -Headers $Headers -OutFile $Out -UseBasicParsing -TimeoutSec 120

    if (Test-Path $Out) {
        $raw = Import-Csv $Out
        
        # 2. Bulletproof filter for exact Tag ID match
        $data = $raw | Where-Object { 
            $_."Tag IDs" -like "*$TagId*" -or 
            $_.Tag_IDs -like "*$TagId*" -or 
            $_.Tags -like "*$TagName*" 
        }

        $count = ($data | Measure-Object).Count
        
        if ($count -gt 0) {
            # 3. Save verified assets only
            $data | Export-Csv $Out -NoTypeInformation
            Write-Host "Success! Data verified and cleaned." -ForegroundColor Green
            Write-Host "--------------------------------------------------" -ForegroundColor Gray
            Write-Host "Total Assets with Tag ID ${TagId}: " -NoNewline
            Write-Host "$count" -ForegroundColor Yellow -Bold
            Write-Host "--------------------------------------------------" -ForegroundColor Gray
        } else {
            Write-Warning "Filter returned 0 results. Check if assets are currently assigned to Tag ID $TagId"
        }
    }
} 
catch { 
    Write-Host "Error: $($_.Exception.Message)" -ForegroundColor Red 
} 
finally { 
    $Creds = $null
    $ProgressPreference = 'Continue' 
}



Cannot convert argument "folder", with value: "Downloads", for "GetFolderPath" to type "System.Environment+SpecialFolder": "Cannot convert value "Downloads" to type "System.Environment+SpecialFolder". Error: "Unable to match 
the identifier name Downloads to a valid enumerator name. Specify one of the following enumerator names and try again:
Desktop, Programs, MyDocuments, Personal, Favorites, Startup, Recent, SendTo, StartMenu, MyMusic, MyVideos, DesktopDirectory, MyComputer, NetworkShortcuts, Fonts, Templates, CommonStartMenu, CommonPrograms, CommonStartup,      
CommonDesktopDirectory, ApplicationData, PrinterShortcuts, LocalApplicationData, InternetCache, Cookies, History, CommonApplicationData, Windows, System, ProgramFiles, MyPictures, UserProfile, SystemX86, ProgramFilesX86,       
CommonProgramFiles, CommonProgramFilesX86, CommonTemplates, CommonDocuments, CommonAdminTools, AdminTools, CommonMusic, CommonPictures, CommonVideos, Resources, LocalizedResources, CommonOemLinks, CDBurning""
At C:\Users\C567346\PycharmProjects\PythonProject\.venv\Scripts\Cloud_Agent.ps1:16 char:1
+ $Out = Join-Path ([Environment]::GetFolderPath("Downloads")) "Qualys_ ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : NotSpecified: (:) [], MethodException
    + FullyQualifiedErrorId : MethodArgumentConversionInvalidCastArgument
