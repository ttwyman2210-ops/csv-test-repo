# --- Ensure modern TLS & Performance Optimization ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
$ProgressPreference = 'SilentlyContinue'

# --- Prompt for credentials ---
$Username = Read-Host "Enter your Qualys API username"
$SecurePassword = Read-Host "Enter your Qualys API password" -AsSecureString

$bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($SecurePassword)
try {
    $PlainPassword = [System.Runtime.InteropServices.Marshal]::PtrToStringAuto($bstr)
    $pair = "${Username}:${PlainPassword}"
    $encodedCreds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($pair))
} finally {
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)
    $PlainPassword = $null
    $pair = $null
}

$Headers = @{
    Authorization    = "Basic $encodedCreds"
    "X-Requested-With" = "PowerShell"
    "Accept"           = "text/csv"
}

# --- Configuration ---
$TargetTagId = "26865192"
$BaseUrl = "https://qualysapi.qg4.apps.qualys.com/api/5.0/fo/asset/host/"

# --- Build STRICT query string ---
$qs = "action=list" +
      "&use_tags=1" +
      "&tag_set_by=id" +
      "&tag_include_selector=all" +
      "&tag_set_include=$TargetTagId" +
      "&show_tags=1"

$Uri = "$BaseUrl`?$qs"

# --- Resolve Local Path (Downloads) ---
try {
    $DownloadsPath = (New-Object -ComObject Shell.Application).Namespace('shell:Downloads').Self.Path
} catch {
    $Downloads


\PycharmProjects\PythonProject\.venv\Scripts> .\Cloud_Agent.ps1
At C:\Users\C567346\PycharmProjects\PythonProject\.venv\Scripts\Cloud_Agent.ps1:43 char:8
+ } catch }
+        ~
The Catch block is missing its statement block.
At C:\Users\C567346\PycharmProjects\PythonProject\.venv\Scripts\Cloud_Agent.ps1:43 char:9
+ } catch }
+         ~
Unexpected token '}' in expression or statement.
    + CategoryInfo          : ParserError: (:) [], ParseException
